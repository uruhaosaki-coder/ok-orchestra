<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- タイトルもひらがな版に変更 -->
    <title>①まずは がっき を えらんでみよう！</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            scroll-behavior: smooth;
        }
        
        /* 選択中のボタンスタイル (通常のCSS) */
        .track-button.selected {
            background-color: #D3C34A; /* 黄色 */
            color: #1B2A5C;            /* 濃い青文字 */
            border: 4px solid #fde68a; /* ring-yellow-200 の代わり */
            font-weight: bold;
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        /* ボタンの文字サイズを自動調整 */
        .track-button {
            /* 1行で表示し、はみ出たら ... に */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* 文字サイズを少し小さくして長い曲名に対応 */
            font-size: 0.8rem; /* 14px -> 12.8px */
            line-height: 1.2;  /* 縦方向の中央揃えを改善 */
        }
    </style>
</head>
<!-- 背景を #717071 (グレー) に変更 -->
<body class="bg-[#717071] flex items-center justify-center min-h-screen p-4">

    <!-- カードの背景色を #1B2A5C (濃い青) に変更 -->
    <div class="w-full max-w-3xl bg-[#1B2A5C] rounded-lg shadow-xl p-6">
        <!-- 1. タイトルを「①まずは がっき を えらんでみよう！」に変更 -->
        <!-- ★フォントサイズを text-2xl から text-xl に変更★ -->
        <h1 class="text-xl font-bold text-center text-[#D3C34A] mb-6">①まずは がっき を えらんでみよう！</h1>

        <!-- トラック選択ボタン (12個用にレイアウト変更) -->
        <div id="button-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 mb-6 w-full">
            <template id="track-button-template">
                <!-- Trackボタン: 白背景(bg-white)、青文字(text-[#1B2A5C]) -->
                <button class="track-button text-[#1B2A5C] font-bold py-4 px-2 rounded-lg bg-white hover:bg-gray-100 transition-all duration-200 shadow-md border-4 border-transparent">
                    (Instrument)
                </button>
            </template>
        </div>

        <!-- 2. 案内文をボタンの下に追加 -->
        <h2 class="text-xl font-bold text-center text-[#D3C34A] mb-6">②さいせいボタン を おして、きいてみよう！</h2>

        <!-- 操作ボタン -->
        <div class="flex space-x-4">
            <!-- 3. ボタンの文字を「さいせい」に変更 & 色を #9AB700 に変更 -->
            <button id="play-button" class="flex-1 bg-[#9AB700] hover:bg-[#82a000] text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                さいせい
            </button>
            <!-- 4. ボタンの文字を「とめる」に変更 & 色を #AC220D に変更 -->
            <button id="stop-button" class="flex-1 bg-[#AC220D] hover:bg-[#8A1C0A] text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                とめる
            </button>
        </div>

        <!-- ステータス表示 (明るいグレー) -->
        <div id="status" class="text-center text-gray-300 mt-4 h-6"></div>
    </div>

    <script>
        // --- ▼ 音源設定 (プレビュー確認用・オーケストラ版) ▼ ---
        
        // ▼ 楽器名 (12種類) ▼
        const TRACK_NAMES = [
            "ヴァイオリン", "ヴィオラ", "チェロ", "コントラバス",
            "クラリネット", "フルート", "オーボエ", "ファゴット",
            "トランペット", "トロンボーン", "ホルン", "チューバ"
        ];
        
        // ▼ 音源URL (12種類) - .wav に変更 ▼
        const TRACK_URLS = [
            "wide_25-11_music_2-15a_orchestra_Violin.wav", // ヴァイオリン
            "wide_25-11_music_2-15b_orchestra_Viola.wav", // ヴィオラ
            "wide_25-11_music_2-15c_orchestra_Cello.wav", // チェロ
            "wide_25-11_music_2-15d_orchestra_Contrabass.wav", // コントラバス
            "wide_25-11_music_2-15e_orchestra_Clarinet.wav", // クラリネット
            "wide_25-11_music_2-15f_orchestra_Flute.wav", // フルート
            "wide_25-11_music_2-15g_orchestra_Oboe.wav", // オーボエ
            "wide_25-11_music_2-15h_orchestra_Fagot.wav", // ファゴット
            "wide_25-11_music_2-15i_orchestra_Trumpet.wav", // トランペット
            "wide_25-11_music_2-15j_orchestra_Trombone.wav", // トロンボーン
            "wide_25-11_music_2-15k_orchestra_Horn.wav", // ホルン
            "wide_25-11_music_2-15l_orchestra_Tuba.wav"  // チューバ
        ];
        // --- ▲ 音源設定 ▲ ---


        // Audioオブジェクトのプール (12個 + 予備)
        const audioPlayers = [];
        const MAX_PLAYERS = 15; // 12個以上
        for (let i = 0; i < MAX_PLAYERS; i++) {
            audioPlayers.push(new Audio());
        }
        
        let playerIndex = 0; // 次に使うAudioオブジェクトのインデックス
        let currentPlayingPlayers = []; // 現在再生中のプレイヤーの参照

        // DOM要素
        const buttonContainer = document.getElementById('button-container');
        const playButton = document.getElementById('play-button');
        const stopButton = document.getElementById('stop-button');
        const statusEl = document.getElementById('status');
        const template = document.getElementById('track-button-template');

        let selectedIndices = new Set(); // 選択中のトラック (Setで管理)
        let trackButtons = []; // ボタンの参照を保持する配列

        // --- 初期化 ---
        
        if (template && buttonContainer) {
            // トラックボタンを生成
            TRACK_NAMES.forEach((name, index) => {
                const clone = template.content.cloneNode(true);
                const button = clone.querySelector('.track-button');
                
                button.textContent = name;
                button.dataset.index = index; 

                button.addEventListener('click', () => {
                    // トラックボタンクリックで選択/選択解除
                    toggleTrackSelection(index);
                });

                buttonContainer.appendChild(clone);
                trackButtons.push(button); 
            });
        } else {
            console.error("初期化エラー: button-container または track-button-template が見つかりません。");
            statusEl.textContent = "ボタンの初期化に失敗しました";
        }

        // トラック選択/選択解除のロジック (トグル)
        function toggleTrackSelection(index) {
            if (selectedIndices.has(index)) {
                selectedIndices.delete(index);
            } else {
                selectedIndices.add(index);
            }
            
            // ボタンの選択状態（色）を更新
            trackButtons[index].classList.toggle('selected', selectedIndices.has(index));
            
            // 選択中の楽器数を表示
            if (selectedIndices.size > 0) {
                statusEl.textContent = `${selectedIndices.size} こ の がっき を えらんでいます`;
            } else {
                statusEl.textContent = "がっき を えらんでください";
            }
        }

        // --- 再生ロジック ---

        playButton.addEventListener('click', playSelected);
        stopButton.addEventListener('click', stopAllAudio);

        // 「再生」ボタン (同時再生) のロジック
        function playSelected() {
            stopAllAudio(); // まずすべての音を止める

            const indicesToPlay = Array.from(selectedIndices);
            if (indicesToPlay.length === 0) {
                statusEl.textContent = "さいせい する がっき が えらばれていません";
                return;
            }

            statusEl.textContent = `${indicesToPlay.length} こ の がっき を さいせい中...`;
            console.log(`Playing ${indicesToPlay.length} tracks simultaneously.`);

            // ▼ 音量調整ロジック ▼
            // 選択数が増えるほど、各音量を下げる
            // 1個: 1.0, 2個: 0.8, 3個: 0.7, 4個: 0.6, 5個以上: 0.5
            let volume = 1.0;
            const count = indicesToPlay.length;
            if (count === 2) {
                volume = 0.8;
            } else if (count === 3) {
                volume = 0.7;
            } else if (count === 4) {
                volume = 0.6;
            } else if (count >= 5) {
                volume = 0.5;
            }
            // ▲ 音量調整ロジック ▲


            indicesToPlay.forEach(index => {
                const url = TRACK_URLS[index];
                
                // オーディオプレイヤーをプールから取得
                const player = audioPlayers[playerIndex];
                playerIndex = (playerIndex + 1) % MAX_PLAYERS; // 次のプレイヤーのインデックス
                
                player.src = url;
                player.volume = volume; // 調整した音量を設定
                player.currentTime = 0; // 念のためリセット
                
                // 再生が終わったらリストから除く（エラーハンドリングも兼ねる）
                const onPlayEnd = () => {
                    player.removeEventListener('ended', onPlayEnd);
                    player.removeEventListener('error', onPlayEnd);
                    // 再生中リストから削除
                    currentPlayingPlayers = currentPlayingPlayers.filter(p => p !== player);
                    // すべての再生が終わったらステータスを更新
                    if (currentPlayingPlayers.length === 0 && !player.paused) {
                         statusEl.textContent = "さいせい しゅうりょう";
                    }
                };
                
                player.addEventListener('ended', onPlayEnd);
                player.addEventListener('error', (e) => {
                    console.error(`Playback error (${TRACK_NAMES[index]}):`, e.message);
                    onPlayEnd(); // エラーでもリストから除く
                });

                player.play().catch(e => {
                    console.error(`Playback error (${TRACK_NAMES[index]}):`, e.message);
                    statusEl.textContent = `さいせいエラー (${TRACK_NAMES[index]})`;
                });
                
                currentPlayingPlayers.push(player); // 再生中リストに追加
            });
        }


        // 停止ボタン（すべて停止）のロジック
        function stopAllAudio() {
            console.log("Stopping all audio...");
            audioPlayers.forEach(player => {
                if (player) {
                    player.pause();
                    player.currentTime = 0;
                    // イベントリスナーは再生時に都度設定するので、ここでは解除不要
                }
            });
            currentPlayingPlayers = []; // 再生中リストをクリア
            // ▼ メッセージを「とめました」に変更 ▼
            statusEl.textContent = "とめました";
        }

        // 初期ステータスメッセージ
        statusEl.textContent = "がっき を えらんでください";

    </script>
</body>
</html>
